<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head('Chat - ' + ${chat.documentFilename}, ~{::chat-assets})}">
    <th:block th:fragment="chat-assets">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
            body { background-color: #F9FAFB; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

            /* Анимация за "Мислене..." */
            .thinking-dots span { animation: blink 1.5s infinite; font-size: 18px; font-weight: bold; }
            .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
            .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

            .modern-spinner {
                width: 64px; height: 64px;
                border: 6px solid #E5E7EB; border-top-color: #5D5DFE;
                border-radius: 50%; animation: spin 1s linear infinite;
            }
            @keyframes spin { to { transform: rotate(360deg); } }
            @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

            .status-bar { background: #5D5DFE; color: white; padding: 8px; text-align: center; font-size: 13px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 10; }
            .chat-container { display: flex; flex: 1; overflow: hidden; position: relative; }

            .document-viewer { flex: 1; border-right: 1px solid #E5E7EB; display: flex; flex-direction: column; background: #F3F4F6; position: relative; overflow: hidden; }
            .viewer-header { background: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #E5E7EB; flex-shrink: 0; }

            #processingUI {
                position: absolute; inset: 0; background: #F9FAFB; z-index: 100;
                display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px;
            }

            .chat-panel { width: 45%; display: flex; flex-direction: column; background: white; }
            .chat-messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
            .bubble { padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-wrap: break-word; }
            .ai-bubble { background: #F3F4F6; color: #1F2937; border-bottom-left-radius: 2px; align-self: flex-start; }
            .user-bubble { background: #5D5DFE; color: white; border-bottom-right-radius: 2px; align-self: flex-end; }

            .chat-footer { padding: 24px; border-top: 1px solid #F3F4F6; }
            .input-wrapper { position: relative; display: flex; align-items: center; }
            .chat-input { width: 100%; padding: 16px 60px 16px 16px; border: 1px solid #E5E7EB; border-radius: 12px; font-size: 14px; outline: none; transition: border-color 0.2s; resize: none; height: 56px; }
            .send-btn { position: absolute; right: 8px; background: #5D5DFE; border: none; padding: 10px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        </style>
    </th:block>
</head>

<body>

<div class="status-bar">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    <span th:text="#{chat.status.chatting}">Chatting with:</span> <strong th:text="${chat.documentFilename}">Lecture_Notes.pdf</strong>
</div>

<div class="chat-container">
    <section class="document-viewer" id="documentViewer">
        <div class="viewer-header">
            <a th:href="@{/dashboard}" class="back-link" style="color: #374151; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                <span th:text="#{chat.button.back}">Back</span>
            </a>
            <span style="font-size: 14px; color: #6B7280;" th:text="${chat.documentFilename}">filename.pdf</span>
        </div>

        <div style="flex: 1; position: relative; width: 100%;">
            <div id="processingUI" th:style="${chat.stage.name() != 'COMPLETED' ? 'display: flex;' : 'display: none;'}">
                <div id="modernSpinner" class="modern-spinner" th:style="${chat.stage.name() == 'FAILED' ? 'display: none;' : ''}"></div>
                <div id="errorIcon" th:style="${chat.stage.name() == 'FAILED' ? 'display: block;' : 'display: none;'}" style="color: #EF4444; margin-bottom: 20px;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                </div>
                <h2 id="processingTitle" style="margin-top: 24px; color: #111827; font-size: 20px; font-weight: 700;"
                    th:text="${chat.stage.name() == 'FAILED' ? #messages.msg('chat.processing.failed') : #messages.msg('chat.processing.title')}">
                    Processing Document
                </h2>
                <div style="margin-top: 16px; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                    <div id="statusBadge" style="display: flex; align-items: center; gap: 8px; background: white; padding: 8px 16px; border-radius: 24px; border: 1px solid #E5E7EB; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <span id="statusDot" th:style="${chat.stage.name() == 'FAILED' ? 'display: none;' : ''}"
                              style="width: 10px; height: 10px; background: #5D5DFE; border-radius: 50%; animation: pulse 1.5s infinite;"></span>
                        <span id="currentStageText" style="color: #4B5563; font-weight: 700; text-transform: uppercase;" th:text="${chat.stage}">UPLOADED</span>
                    </div>
                    <p id="processingDesc" style="margin-top: 16px; color: #6B7280; font-size: 14px; max-width: 340px; line-height: 1.6; text-align: center;"
                       th:text="${chat.stage.name() == 'FAILED' ? chat.errorMessage : #messages.msg('chat.processing.desc')}">
                        The AI engine is currently indexing your file.
                    </p>
                    <a id="errorBackBtn" th:href="@{/dashboard}" th:style="${chat.stage.name() == 'FAILED' ? 'display: block;' : 'display: none;'}"
                       style="margin-top: 20px; background: #5D5DFE; color: white; padding: 10px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: background 0.2s;"
                       th:text="#{chat.button.return}">
                        Return to Dashboard
                    </a>
                </div>
            </div>

            <div id="documentContent" th:style="${chat.stage.name() == 'COMPLETED' ? 'display: block;' : 'display: none;'}"
                 style="width: 100%; height: 100%; overflow-y: auto; padding: 40px; background: #F3F4F6;">

                <div th:if="${#lists.isEmpty(chat.messages)}"
                     style="background: white; max-width: 800px; margin: 0 auto; min-height: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #E5E7EB; padding: 60px; border-radius: 8px;">
                    <h1 style="color: #111827; font-size: 24px; margin-bottom: 20px;" th:text="#{chat.preview.title}">Document Preview</h1>
                    <div style="display: flex; align-items: center; gap: 12px; color: #059669; background: #ECFDF5; padding: 16px; border-radius: 8px; margin-bottom: 30px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        <span style="font-weight: 600;" th:text="#{chat.preview.complete}">The document indexing is complete.</span>
                    </div>
                    <p style="color: #4B5563; line-height: 1.8; font-size: 15px;" th:text="#{chat.preview.ready}">Your file has been successfully processed.</p>
                </div>

                <div th:if="${not #lists.isEmpty(chat.messages)}" style="max-width: 800px; margin: 0 auto;">
                    <div style="margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <h2 style="color: #111827; font-size: 18px; font-weight: 700;" th:text="#{chat.sources.title}">Reference Sources</h2>
                            <p style="color: #6B7280; font-size: 13px; margin-top: 4px;">
                                <span th:text="#{chat.sources.subtitle}">Verified chunks from</span> <span th:text="${chat.documentFilename}">document.pdf</span>
                            </p>
                        </div>
                        <span style="background: #E0E7FF; color: #4338CA; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;" th:text="#{chat.sources.latest}">Latest Response</span>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 16px; overflow-y: auto; max-height: 70vh; padding-right: 10px; scrollbar-width: thin; scroll-behavior: smooth;">
                        <th:block th:each="msg : ${chat.messages}">
                            <th:block th:if="${msg.role == 'ASSISTANT' && msgStat.last}">
                                <div th:each="source, iter : ${msg.sources}"
                                     style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #E5E7EB; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                        <div style="width: 24px; height: 24px; background: #5D5DFE; color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800;" th:text="${iter.count}">1</div>
                                        <span style="color: #374151; font-size: 12px; font-weight: 600; text-transform: uppercase;" th:text="#{chat.sources.excerpt}">Document Excerpt</span>
                                    </div>
                                    <p style="color: #1F2937; font-size: 14px; line-height: 1.6; font-style: italic; border-left: 3px solid #E5E7EB; padding-left: 16px;" th:text="${source}"></p>
                                </div>
                            </th:block>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="chat-panel">
        <div class="chat-header" style="padding: 20px; border-bottom: 1px solid #F3F4F6;">
            <h2 style="font-size: 18px; font-weight: 700;" th:text="${chat.title}">Chat Title</h2>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div th:each="msg : ${chat.messages}"
                 th:class="${msg.role == 'ASSISTANT' ? 'bubble ai-bubble' : 'bubble user-bubble'}"
                 th:text="${msg.content}"></div>
            <div id="bottom-anchor" style="height: 1px;"></div>
        </div>
        <div class="chat-footer">
            <form th:action="@{/chat/send}" method="post" id="messageForm">
                <div class="input-wrapper">
                    <textarea name="message" class="chat-input" id="userInput" th:placeholder="#{chat.input.placeholder}" required></textarea>
                    <button type="submit" class="send-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </form>
        </div>
    </section>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Променливи за интернационализация
        const jsVectorTitle = [[#{chat.js.vector.title}]];
        const jsVectorDesc = [[#{chat.js.vector.desc}]];
        const jsTimeNow = [[#{chat.js.time.now}]];
        const jsProcessingFailed = [[#{chat.processing.failed}]];
        const jsStatusError = [[#{chat.status.error}]];

        const docId = [[${chat.documentId}]];
        const initialStage = [[${chat.stage.name()}]];
        const chatMessages = document.getElementById('chatMessages');
        const messageForm = document.getElementById('messageForm');
        const userInput = document.getElementById('userInput');

        // Скрол до дъното при зареждане
        if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;

        // --- ЛОГИКА ЗА ИЗПРАЩАНЕ НА СЪОБЩЕНИЕ (FETCH) ---
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const text = userInput.value.trim();
            if (!text) return;

            // 1. Показваме веднага съобщението на потребителя
            const userDiv = document.createElement('div');
            userDiv.className = 'bubble user-bubble';
            userDiv.textContent = text;
            chatMessages.appendChild(userDiv);

            // 2. Изчистваме полето
            userInput.value = '';

            // 3. Показваме пулсиращите точки "Thinking..."
            const aiThinkingDiv = document.createElement('div');
            aiThinkingDiv.className = 'bubble ai-bubble thinking-dots';
            aiThinkingDiv.innerHTML = `<span>.</span><span>.</span><span>.</span>`;
            chatMessages.appendChild(aiThinkingDiv);

            // Скрол до новото съобщение
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // 4. Изпращаме заявката асинхронно
            const formData = new FormData(messageForm);
            formData.set('message', text);

            fetch(messageForm.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    // Когато отговорът е готов, презареждаме за целия списък и източниците
                    window.location.reload();
                }
            }).catch(err => {
                aiThinkingDiv.textContent = "Грешка при връзката.";
                console.error(err);
            });
        });

        // --- ЛОГИКА ЗА WEBSOCKET (СТАТУС НА ДОКУМЕНТ) ---
        if (initialStage !== 'COMPLETED' && initialStage !== 'FAILED') {
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);
            stompClient.debug = null;

            stompClient.connect({}, function () {
                stompClient.subscribe('/topic/doc-status/' + docId, function (response) {
                    const data = JSON.parse(response.body);

                    if (data.status === 'COMPLETED') {
                        window.location.reload();
                    }
                    else if (data.status === 'FAILED') {
                        document.getElementById('modernSpinner').style.display = 'none';
                        document.getElementById('statusDot').style.display = 'none';
                        document.getElementById('errorIcon').style.display = 'block';

                        const title = document.getElementById('processingTitle');
                        title.textContent = jsProcessingFailed;
                        title.style.color = "#EF4444";

                        const stageText = document.getElementById('currentStageText');
                        stageText.textContent = jsStatusError;
                        stageText.style.color = "#EF4444";

                        const desc = document.getElementById('processingDesc');
                        desc.textContent = data.message;
                        desc.style.color = "#B91C1C";

                        document.getElementById('errorBackBtn').style.display = 'block';
                        stompClient.disconnect();
                    }
                    else {
                        const stageText = document.getElementById('currentStageText');
                        if (stageText) stageText.textContent = data.status || data;
                    }
                });
            });
        }
    });

    // Обработка на Enter без Shift
    document.getElementById('userInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('messageForm').dispatchEvent(new Event('submit'));
        }
    });
</script>
</body>
</html>