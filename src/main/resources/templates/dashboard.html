<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - KnowledgeHub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
<div class="dashboard-wrapper">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <span class="logo-icon">K</span>
            <span class="logo-text">KnowledgeHub</span>
        </div>
        <nav class="sidebar-nav">
            <a href="/templates/dashboard.html" class="nav-item active">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 10L10 3L17 10M7 18V12H13V18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Dashboard</span>
            </a>
            <a th:href="@{/admin/monitor}" class="nav-item" sec:authorize="hasRole('ADMIN')">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 2L3 6V18C3 18.5304 3.21071 19.0391 3.58579 19.4142C3.96086 19.7893 4.46957 20 5 20H15C15.5304 20 16.0391 19.7893 16.4142 19.4142C16.7893 19.0391 17 18.5304 17 18V6L11 2M9 2H11M9 2V8H11V2M5 20V9H15V20"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Admin Monitor</span>
            </a>
            <a href="/settings" class="nav-item">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 12C11.1046 12 12 11.1046 12 10C12 8.89543 11.1046 8 10 8C8.89543 8 8 8.89543 8 10C8 11.1046 8.89543 12 10 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16.658 13.6906C16.5408 13.9158 16.4914 14.1716 16.5158 14.4245C16.5402 14.6774 16.6373 14.9158 16.7947 15.1097C16.9521 15.3036 17.1622 15.4445 17.3976 15.5144C17.633 15.5842 17.8833 15.5798 18.1159 15.5019L18.7416 15.2922C18.9742 15.2142 19.1787 15.0661 19.3292 14.8659C19.4796 14.6657 19.5693 14.4223 19.5865 14.1676C19.6037 13.9129 19.5476 13.6581 19.4249 13.4369L18.6866 12.2387C18.5639 12.0175 18.3814 11.8396 18.1622 11.7263C17.943 11.613 17.6966 11.5691 17.453 11.6004C17.2095 11.6317 16.9796 11.7368 16.7947 11.9022C16.6098 12.0677 16.4783 12.2862 16.4171 12.5287L16.2249 13.2906C16.1881 13.4214 16.1694 13.5569 16.1694 13.6931C16.1694 13.8293 16.1881 13.9648 16.2249 14.0956L16.658 13.6906Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3.34202 6.30937C3.45918 6.08422 3.50862 5.82843 3.48418 5.57554C3.45974 5.32264 3.36273 5.08416 3.20533 4.89031C3.04793 4.69646 2.83776 4.55546 2.60237 4.48563C2.36697 4.41581 2.11666 4.42018 1.88406 4.49806L1.25838 4.70781C1.02578 4.78569 0.821304 4.93382 0.670829 5.13404C0.520354 5.33426 0.430718 5.57766 0.413527 5.83237C0.396336 6.08707 0.452408 6.34187 0.575117 6.56312L1.31344 7.76125C1.43615 7.9825 1.61863 8.16039 1.83781 8.27369C2.05699 8.38699 2.30341 8.43086 2.54696 8.39959C2.79051 8.36832 3.0204 8.26316 3.20533 8.09775C3.39026 7.93234 3.52173 7.71378 3.58289 7.47131L3.77506 6.70937C3.81185 6.57864 3.83058 6.44306 3.83058 6.30687C3.83058 6.17069 3.81185 6.03511 3.77506 5.90437L3.34202 6.30937Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16.658 6.30937L16.2249 5.90437C16.1881 5.77364 16.1694 5.63806 16.1694 5.50187C16.1694 5.36569 16.1881 5.23011 16.2249 5.09937L16.4171 4.3375C16.4783 4.09503 16.6098 3.87647 16.7947 3.71106C16.9796 3.54565 17.2095 3.44049 17.453 3.40922C17.6966 3.37795 17.943 3.42182 18.1622 3.53512C18.3814 3.64842 18.5639 3.82631 18.6866 4.04756L19.4249 5.24569C19.5476 5.46694 19.6037 5.72174 19.5865 5.97644C19.5693 6.23115 19.4796 6.47455 19.3292 6.67477C19.1787 6.87499 18.9742 7.02312 18.7416 7.101L18.1159 7.31075C17.8833 7.38863 17.633 7.38426 17.3976 7.31444C17.1622 7.24462 16.9521 7.10362 16.7947 6.90977C16.6373 6.71592 16.5402 6.47744 16.5158 6.22454C16.4914 5.97165 16.5408 5.71586 16.658 5.49071L16.658 6.30937Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3.34202 13.6906L3.77506 14.0956C3.81185 14.2264 3.83058 14.3619 3.83058 14.4981C3.83058 14.6343 3.81185 14.7698 3.77506 14.9006L3.58289 15.6625C3.52173 15.905 3.39026 16.1235 3.20533 16.2889C3.0204 16.4544 2.79051 16.5595 2.54696 16.5908C2.30341 16.6221 2.05699 16.5782 1.83781 16.4649C1.61863 16.3516 1.43615 16.1737 1.31344 15.9525L0.575117 14.7543C0.452408 14.5331 0.396336 14.2783 0.413527 14.0236C0.430718 13.7689 0.520354 13.5255 0.670829 13.3253C0.821304 13.125 1.02578 12.9769 1.25838 12.899L1.88406 12.6893C2.11666 12.6114 2.36697 12.6158 2.60237 12.6856C2.83776 12.7554 3.04793 12.8964 3.20533 13.0903C3.36273 13.2842 3.45974 13.5226 3.48418 13.7755C3.50862 14.0284 3.45918 14.2842 3.34202 14.5094L3.34202 13.6906Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Settings</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">JD</div>
                <div class="user-info">
                    <div class="user-name">John Doe</div>
                    <div class="user-plan">Free Plan</div>
                </div>
            </div>
            <a href="/templates/index.html" class="logout-btn">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 2H4C3.46957 2 2.96086 2.21071 2.58579 2.58579C2.21071 2.96086 2 3.46957 2 4V14C2 14.5304 2.21071 15.0391 2.58579 15.4142C2.96086 15.7893 3.46957 16 4 16H7M12 13L16 9M16 9L12 5M16 9H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <main class="main-content">
        <header class="content-header">
            <div class="header-left">
                <h1 class="page-title">My Document Chats</h1>
                <p class="page-subtitle">6 documents</p>
            </div>
            <button class="upload-btn" id="openModalBtn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>Upload New File</span>
            </button>
        </header>

        <div class="info-banner">
            <svg class="info-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 14V10M10 6H10.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <p>One File = One Chat: Each document gets its own dedicated conversation. Click any card below to continue chatting with that specific file.</p>
        </div>

        <div class="documents-grid">
            <div th:each="chat : ${allChats}" class="doc-card"
                 th:onclick="|window.location.href='/chats/' + ${chat.chatId}|"
                 style="cursor: pointer;">

                <div class="doc-card-header">
                    <div class="doc-file-info">
                        <svg class="file-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#5D5DFE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 2V8H20" stroke="#5D5DFE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="doc-filename" th:text="${chat.filename}">Filename.pdf</span>
                    </div>

                    <span th:class="'status-badge ' + ${chat.documentStatus.toString().toLowerCase()}"
                          th:text="${chat.documentStatus}">Ready</span>
                </div>

                <div class="doc-card-body">
                    <p class="doc-date" th:text="${#temporals.format(chat.uploadedAt, 'MMM dd, yyyy')}">Dec 20, 2024</p>
                    <p class="doc-preview" th:text="${chat.title}">"Chat Title Preview"</p>
                </div>
            </div>

            <div class="doc-card start-new-card" id="openModalCard" style="cursor: pointer;">
                <div class="start-new-content">
                    <svg class="plus-icon" width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M24 12V36M12 24H36" stroke="#5D5DFE" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                    <p class="start-new-text">Start New Chat</p>
                    <p class="start-new-subtext">Upload a document</p>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="uploadModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 9999; justify-content: center; align-items: center; font-family: 'Inter', sans-serif;">
    <div style="background: white; width: 500px; border-radius: 16px; padding: 32px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); position: relative;">

        <form th:action="@{/chats/create}" method="POST" enctype="multipart/form-data" id="uploadForm">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h2 style="font-size: 20px; font-weight: 700; color: #111827; margin: 0;">Start a New Chat</h2>
                <button type="button" id="closeModalX" style="background: none; border: none; cursor: pointer; color: #9CA3AF; padding: 4px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <p style="color: #6B7280; font-size: 14px; margin-bottom: 24px;">Upload a document to begin chatting</p>

            <input type="file" id="realFileInput" name="file" style="display: none;" accept=".pdf,.docx,.ppt,.pptx">

            <div id="dropZone" style="border: 2px dashed #D1D5DB; border-radius: 12px; padding: 40px 20px; text-align: center; margin-bottom: 24px; background: #F9FAFB; cursor: pointer; transition: all 0.2s;">
                <div style="background: #EEF2FF; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#5D5DFE" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                </div>
                <p id="fileNameDisplay" style="font-size: 14px; color: #374151; font-weight: 500; margin-bottom: 4px;">Drag & drop your PDF, DOCX, or PPT here</p>
                <p id="browseLink" style="font-size: 14px; color: #6B7280;">or <span style="color: #5D5DFE; text-decoration: underline;">browse files</span></p>
            </div>

            <div style="background: #F3F4FF; border-radius: 8px; padding: 12px 16px; margin-bottom: 24px; border-left: 4px solid #5D5DFE;">
                <p style="font-size: 12px; color: #4F46E5; margin: 0; line-height: 1.5;">
                    <strong>Note:</strong> One file per chat session.
                </p>
            </div>

            <div style="display: flex; gap: 12px;">
                <button type="button" id="cancelModalBtn" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #D1D5DB; background: white; color: #374151; font-weight: 600; cursor: pointer;">Cancel</button>
                <button type="submit" id="analyzeBtn" style="flex: 2; padding: 12px; border-radius: 8px; border: none; background: #5D5DFE; color: white; font-weight: 600; cursor: pointer; opacity: 0.5;" disabled>Analyze & Start Chat</button>
            </div>
        </form>
    </div>
</div>

<button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
</button>

<script>
    const modal = document.getElementById('uploadModal');
    const openBtn = document.getElementById('openModalBtn');
    const openCard = document.getElementById('openModalCard');
    const dropZone = document.getElementById('dropZone');
    const realFileInput = document.getElementById('realFileInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const cancelBtn = document.getElementById('cancelModalBtn');
    const closeX = document.getElementById('closeModalX');

    // Отваряне/Затваряне
    const showModal = () => modal.style.display = 'flex';
    const hideModal = () => {
        modal.style.display = 'none';
        resetUpload();
    };

    openBtn.addEventListener('click', showModal);
    openCard.addEventListener('click', showModal);
    cancelBtn.addEventListener('click', hideModal);
    closeX.addEventListener('click', hideModal);

    // Клик върху зоната за качване
    dropZone.addEventListener('click', () => realFileInput.click());

    // Когато файлът е избран
    realFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    function handleFileSelect(file) {
        fileNameDisplay.innerText = "Selected: " + file.name;
        fileNameDisplay.style.color = "#5D5DFE";
        analyzeBtn.disabled = false;
        analyzeBtn.style.opacity = "1";
    }

    function resetUpload() {
        realFileInput.value = "";
        fileNameDisplay.innerText = "Drag & drop your PDF, DOCX, or PPT here";
        fileNameDisplay.style.color = "#374151";
        analyzeBtn.disabled = true;
        analyzeBtn.style.opacity = "0.5";
    }

    // Drag & Drop функционалност
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.background = "#EEF2FF";
        dropZone.style.borderColor = "#5D5DFE";
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.background = "#F9FAFB";
        dropZone.style.borderColor = "#D1D5DB";
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = "#F9FAFB";
        if (e.dataTransfer.files.length > 0) {
            realFileInput.files = e.dataTransfer.files;
            handleFileSelect(e.dataTransfer.files[0]);
        }
    });

    // Бутон за анализ (Backend връзка)
    analyzeBtn.addEventListener('click', () => {
        const file = realFileInput.files[0];
        alert("Изпращане на " + file.name + " към твоя Ryzen 7 за векторизация...");
        // Тук ще добавим реалния fetch към твоя Java Controller
    });
</script>
</body>
</html>