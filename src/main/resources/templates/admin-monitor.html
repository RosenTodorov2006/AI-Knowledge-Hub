<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head(#{admin.monitor.page.title}, ~{::link})}">
    <link rel="stylesheet" th:href="@{/css/admin-monitor.css}">
</head>

<style>
    .stat-purple { border-top: 4px solid #8e44ad; }
    .stat-indigo { border-top: 4px solid #3f51b5; }

    .error-text {
        cursor: pointer;
        transition: all 0.2s ease;
        max-width: 250px;
    }

    .error-text:hover { background-color: rgba(239, 83, 80, 0.05); }

    .error-content {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .expanded .error-content {
        white-space: pre-wrap;
        word-break: break-word;
        overflow: visible;
        max-width: 500px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }

    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<body>
<div class="dashboard-wrapper">
    <aside th:replace="~{fragments/layout :: sidebar('monitor', ${currentUser})}"></aside>

    <main class="main-content">
        <header class="admin-header">
            <div class="header-left">
                <nav class="breadcrumb">
                    <span th:text="#{admin.monitor.breadcrumb.system}">System Monitor</span>
                    <span class="breadcrumb-separator">></span>
                    <span th:text="#{admin.monitor.breadcrumb.queue}">Document Processing Queue</span>
                </nav>
                <h1 class="page-title" th:text="#{admin.monitor.title}">Processing Monitor</h1>
            </div>
            <div class="header-right">
                <div class="status-badge operational">
                    <span class="status-dot"></span>
                    <span th:text="#{admin.monitor.status.operational}">All Systems Operational</span>
                </div>
            </div>
        </header>

        <div id="monitor-content" th:fragment="monitor-content">
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 32px;">

                <div class="stat-card" style="border-top: 4px solid #3B82F6; background: white; padding: 24px; border-radius: 12px; border-left: 1px solid #E5E7EB; border-right: 1px solid #E5E7EB; border-bottom: 1px solid #E5E7EB;">
                    <div class="stat-content">
                        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;" th:text="${stats.currentlyProcessing}">0</div>
                        <div class="stat-label" style="font-size: 0.875rem; color: #6B7280; font-weight: 500;" th:text="#{admin.monitor.stats.processing.label}">Currently Processing</div>
                        <div class="stat-footer" style="font-size: 0.75rem; color: #9CA3AF; margin-top: 4px;" th:text="#{admin.monitor.stats.processing.footer}">Active indexing jobs</div>
                    </div>
                </div>

                <div class="stat-card" style="border-top: 4px solid #10B981; background: white; padding: 24px; border-radius: 12px; border-left: 1px solid #E5E7EB; border-right: 1px solid #E5E7EB; border-bottom: 1px solid #E5E7EB;">
                    <div class="stat-content">
                        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;" th:text="${stats.successRate + '%'}">0%</div>
                        <div class="stat-label" style="font-size: 0.875rem; color: #6B7280; font-weight: 500;" th:text="#{admin.monitor.stats.rate.label}">Success Rate</div>
                        <div class="stat-footer" style="font-size: 0.75rem; color: #9CA3AF; margin-top: 4px;" th:text="#{admin.monitor.stats.rate.footer}">Last 24 hours</div>
                    </div>
                </div>

                <div class="stat-card" style="border-top: 4px solid #F59E0B; background: white; padding: 24px; border-radius: 12px; border-left: 1px solid #E5E7EB; border-right: 1px solid #E5E7EB; border-bottom: 1px solid #E5E7EB;">
                    <div class="stat-content">
                        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;" th:text="${stats.totalVectors}">0</div>
                        <div class="stat-label" style="font-size: 0.875rem; color: #6B7280; font-weight: 500;" th:text="#{admin.monitor.stats.vectors.label}">Vectors Stored</div>
                        <div class="stat-footer" style="font-size: 0.75rem; color: #9CA3AF; margin-top: 4px;" th:text="#{admin.monitor.stats.vectors.footer}">Total embeddings</div>
                    </div>
                </div>

                <div class="stat-card" style="border-top: 4px solid #8B5CF6; background: white; padding: 24px; border-radius: 12px; border-left: 1px solid #E5E7EB; border-right: 1px solid #E5E7EB; border-bottom: 1px solid #E5E7EB;">
                    <div class="stat-content">
                        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;" th:text="${stats.totalChats}">0</div>
                        <div class="stat-label" style="font-size: 0.875rem; color: #6B7280; font-weight: 500;">Active Chats</div>
                        <div class="stat-footer" style="font-size: 0.75rem; color: #9CA3AF; margin-top: 4px;">Total conversations</div>
                    </div>
                </div>

                <div class="stat-card" style="border-top: 4px solid #6366F1; background: white; padding: 24px; border-radius: 12px; border-left: 1px solid #E5E7EB; border-right: 1px solid #E5E7EB; border-bottom: 1px solid #E5E7EB;">
                    <div class="stat-content">
                        <div class="stat-value" style="font-size: 2rem; font-weight: 700; color: #111827;" th:text="${stats.activeUsers}">0</div>
                        <div class="stat-label" style="font-size: 0.875rem; color: #6B7280; font-weight: 500;">Active Users</div>
                        <div class="stat-footer" style="font-size: 0.75rem; color: #9CA3AF; margin-top: 4px;">Registered accounts</div>
                    </div>
                </div>

            </div>
        </div>

            <div class="table-container">
                <table class="processing-table">
                    <thead>
                    <tr>
                        <th th:text="#{admin.monitor.table.header.id}">JOB ID</th>
                        <th th:text="#{admin.monitor.table.header.filename}">FILE NAME</th>
                        <th th:text="#{admin.monitor.table.header.user}">USER</th>
                        <th th:text="#{admin.monitor.table.header.progress}">STAGE PROGRESS</th>
                        <th th:text="#{admin.monitor.table.header.status}">STATUS</th>
                        <th th:text="#{admin.monitor.table.header.errortime}">ERROR / TIME</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="job : ${jobs}">
                        <td class="job-id" th:text="${job.jobId}">#JOB-001</td>
                        <td class="file-name" th:text="${job.fileName}">Research_Paper.pdf</td>
                        <td class="user-name" th:text="${job.userEmail}">user@example.com</td>
                        <td class="stage-progress">
                            <div class="stage-badges">
                                <span class="stage-badge" th:classappend="${job.error == null ? 'completed' : 'failed'}" th:text="#{admin.monitor.table.stage.process}">PROCESS</span>
                                <span class="stage-connector"></span>
                                <span class="stage-badge" th:classappend="${job.error == null ? 'completed' : 'pending'}" th:text="#{admin.monitor.table.stage.embed}">EMBED</span>
                            </div>
                        </td>
                        <td>
                            <span class="status-pill" th:classappend="${job.error == null ? 'status-success' : 'status-failed'}" th:text="${job.error == null} ? #{admin.monitor.table.status.success} : #{admin.monitor.table.status.failed}">Status</span>
                        </td>
                        <td class="error-time" th:classappend="${job.error != null ? 'error-text' : ''}" th:onclick="${job.error != null} ? 'toggleError(this)' : ''">
                            <span class="error-content" th:text="${job.error != null ? job.error : job.timeAgo}">2 min ago</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<button th:replace="~{fragments/layout :: mobile-toggle}"></button>
<th:block th:replace="~{fragments/scripts :: common-scripts}"></th:block>

<script>
    function toggleError(element) {
        element.classList.toggle('expanded');
    }

    // Функция за ТИХО обновяване (Polling) [cite: 2026-02-15]
    function refreshData() {
        // Не обновяваме, ако потребителят чете разширена грешка [cite: 2026-02-15]
        if (document.querySelector('.error-time.expanded')) return;

        fetch('/admin/monitor/updates')
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    window.location.reload(); // Сесията е изтекла [cite: 2026-02-17]
                    return;
                }
                return response.text();
            })
            .then(html => {
                const container = document.getElementById('monitor-content');
                if (container && html) {
                    container.innerHTML = html;
                }
            })
            .catch(err => console.warn("Polling error:", err));
    }

    document.addEventListener('DOMContentLoaded', function() {
        setInterval(refreshData, 30000);
    });
</script>
</body>
</html>